# 完成 TODO.md 中的所有任务

## 1. 子代理工具调用渲染
- **模型更新**：在 `Message` 和 `ContentBlockWrapper` 中增加 `children` 属性。
- **逻辑关联**：在 `processAndAttachMessage` 中通过 `parent_tool_use_id` 将子消息关联到父 `Task` 工具块。
- **UI 渲染**：更新 `Task.vue` 以递归渲染嵌套的子工具调用，并在 `ChatPage.vue` 中过滤顶级消息。

## 2. Plan Mode 优化
- **样式改进**：优化 `ExitPlanMode.vue` 的 Markdown 渲染和卡片样式。
- **流程衔接**：确保 Plan 模式结束后的状态切换和消息提示更加平滑。

## 3. Diff 代码着色
- **高亮实现**：在 `Edit.vue` 和 `Write.vue` 中集成轻量级语法高亮（基于正则或微型库）。
- **主题同步**：使用 VS Code 颜色变量确保高亮风格与编辑器一致。

## 4. 审批时自动打开 Diff 标签页
- **逻辑触发**：在 `ClaudeAgentService.ts` 的 `canUseTool` 回调中，检测到 `Edit`/`Write` 操作时自动调用 `handleOpenDiff`。
- **用户体验**：让用户在点击“允许”之前，能直接在 VS Code 编辑器中看到完整的 Diff。

## 5. 撤回与回滚功能重构
- **UI 重构**：将撤回对话框简化为“撤回所有操作”和“取消”按钮。
- **物理回滚**：
    - 调用 SDK 的 `rewindFiles` 进行文件回滚。
    - 在 `ClaudeSessionService.ts` 中实现历史截断，物理修改 `.jsonl` 文件，确保撤回操作在重新打开会话后依然有效。

## 6. 验证 @-mention 与搜索服务
- **链路检查**：验证 `fileReferenceProvider.ts` 与后端 `fileSystemService` 的搜索衔接。

---
**请确认以上方案，我将立即开始实施。**
